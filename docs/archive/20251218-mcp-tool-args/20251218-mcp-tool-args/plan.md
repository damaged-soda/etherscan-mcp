# MCP 工具参数形态澄清 技术变更计划（Plan）

## 0. 背景与目标（简短即可）
- 背景：调用 MCP 的 `call_function` 时常把单个参数当作字符串传入 `args`，被逐字符拆成列表后触发 “Argument count mismatch: expected 1, got 42”。`query_logs` 的 `topics` 也易被当作单个字符串而非数组，造成调用失败或行为不符。
- 目标：明确 MCP 工具中列表形态的参数（如 `args`、`topics` 等），在接口描述与运行时校验上都给出清晰指引/错误信息，降低误用。
- 非目标：不改动 Etherscan 请求语义或新增其他链上能力。

## 1. 影响范围（必须）
- 影响的 repo（来自 docmap，可多项）：etherscan-mcp
- 影响的模块/目录/文件（按 repo 分组列出即可）：app/mcp_server.py（工具参数声明/校验）、相关文档（SOT/README 如需更新）
- 外部可见变化（如适用：API/CLI/配置/数据格式）：MCP 工具参数说明更明确；对错误形态的 `args`/`topics` 提示更友好。

## 2. 方案与改动点（必须）
说明：实现将按批次推进；每批次写入前需先列出本批次改动文件/影响并征求确认。

- repo: etherscan-mcp
  - 改动点：补充 MCP 工具描述，明确 `call_function.args`、`encode_function_data.args`、`query_logs.topics` 需使用数组；在 MCP 入口对明显错误形态（如传入字符串）做前置校验或转换并给出可读提示。
  - 新增/修改的接口或数据结构：无新增接口；仅参数文案/校验提示更具体。
  - 关键逻辑说明：在 mcp_server 层识别非序列但可包裹的输入或直接报错，避免传递到 service 后被逐字符拆分。

## 3. 自测与验收口径（必须，可执行）
- 本地自测步骤（命令/操作）：如有代码改动，运行针对 MCP 工具的简单调用片段（或单元测试）验证参数校验/提示；无需外部网络变更。
- 关键用例清单：
  - `call_function` 传入 `args` 为字符串时给出明确提示，指导改为数组。
  - `call_function` 传入数组参数时正常编码调用。
  - `query_logs` 传入非数组的 `topics` 时给出提示，数组形态时正常工作。
  - 文档/工具描述中明确列出数组形态示例。
- 通过标准：上述用例均符合预期；无新增报错路径；文档/工具描述能直接指导正确调用。

交付摘要口径（固定）：实现完成后，必须输出交付摘要，包含：
- 实际改动清单（按 repo 列出关键文件/模块）
- 自测步骤与结果
- 对照本节“通过标准”的逐条结论
- 已知风险/未决事项（如有必须列出）

约束：用户验收通过前，不更新 SOT，不归档 WIP。

## 4. SOT 更新清单（必须）
用户验收通过后，要把“最终事实”沉淀到 SOT（至少文件级，V1 不要求精确到小节）：

- docs/sot/overview.md：补充 MCP 工具参数形态（`args`/`topics` 数组要求、错误提示）。
- docs/sot/architecture.md：描述 mcp_server 层的参数校验/形态规范（数组要求与提示）。
- 其他：无

## 5. 完成后归档动作（固定）
实现完成并完成基本自测后：
1) 输出交付摘要并请求用户验收
2) 用户验收通过后，按第 4 节更新 SOT
3) 更新第 6 节检查单（必须全勾）
4) 将整个目录从 docs/wip/YYYYMMDD-topic/ 移动到 docs/archive/YYYYMMDD-topic/

## 6. WIP 检查单（必须全勾才能归档）
- [x] plan.md 已确认（PLAN 闸门已通过）
- [x] 代码改动已完成（IMPLEMENT 完成）
- [x] 基本自测已完成（记录命令/步骤与结果）
- [x] 已输出交付摘要并且用户验收通过（VERIFY 闸门已通过）
- [x] SOT 已更新（按第 4 节执行；列出更新的文件）
- [x] 已归档：wip → archive（目录已移动）
